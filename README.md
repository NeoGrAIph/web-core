# web-core

`web-core` — продуктовый монорепозиторий Synestra для разработки и сопровождения группы сайтов/веб‑приложений (corporate, e‑commerce, SaaS web, лендинги и др.) на стеке **Payload CMS + Next.js**, а также для хранения **GitOps‑артефактов деплоя** этих приложений (шаблоны/values/манифесты), которые применяются через Argo CD.

Репозиторий находится в стадии активной разработки: структура и правила формируются **на основании исследований best practices** под целевую задачу и **анализа официальных шаблонов и документации Payload**.

## Зачем этот репозиторий

- Быстро и качественно разрабатывать несколько сайтов в одном репозитории, переиспользуя общие части (CMS‑модули, блоки, UI, утилиты, конфиги).
- Деплоить сайты **независимо** друг от друга (снижаем риск “всё упало из‑за одного релиза”).
- Поддерживать понятный GitOps‑контракт для Kubernetes/ArgoCD: приложение/values — здесь, кластерная инфраструктура и секреты — в отдельном репозитории.

## Границы ответственности

- `~/synestra-platform` — **платформенный репозиторий** (Kubernetes‑инфраструктура и эксплуатация):
  - путь: `~/synestra-platform`;
  - назначение: управление кластером и общими компонентами платформы;
  - что там есть (типично):
    - Argo CD и “app-of-apps”/корневые Applications для подключения прикладных репозиториев;
    - ingress/cert-manager/DNS‑интеграции и прочие cluster‑level компоненты;
    - операторы (например CloudNativePG), observability/логирование/мониторинг;
    - централизованные базы данных/сервисы данных платформы (если используются);
    - централизованные секреты (SOPS/age и т.п.);
    - CI/CD (GitLab) для сборки и публикации контейнерных образов, которые затем потребляются деплоями.
- `~/repo/web-core` — **код приложений**, общие библиотеки/пакеты, не‑секретные параметры, GitOps‑шаблоны деплоя и документация.

Принцип: **в `web-core` не коммитим plaintext‑секреты**. Здесь допустимы только ссылки на Secret names/keys и `.env.example`.

## Базовые принципы архитектуры

- **Несколько deployments** из одной монорепы (как минимум: corporate / shop / saas / landings).
- Изоляция на deployment:
  - отдельный `namespace`;
  - отдельная БД (стратегия: CloudNativePG, кластер на namespace).
- Окружения проектируем как `dev → stage → prod`, но на старте разворачиваем и показываем результат в `dev`.
- Hot‑разработка в Kubernetes: выбран подход через **Okteto** (конкретный режим интеграции фиксируем по мере внедрения в `synestra-platform`).

## Зафиксированный стек и версии

- Payload CMS: `3.68.3`
- Next.js: `15.4.9`
- Node.js: `>= 22` (см. `package.json`)

## Документация

Начни с индекса: `docs/README.md`.

Ключевые документы:
- Архитектура и взаимодействие репозиториев: `docs/architecture/architecture.md`
- Целевая структура репозитория: `docs/architecture/repo-structure.md`
- Конспект исследований и критерии: `docs/research/research.md`
- Исследование официальных шаблонов Payload: `docs/research/templates-research.md`
- Runbooks (dev‑процессы, первый dev‑деплой): `docs/runbooks/README.md`
- GitOps деплой: `deploy/README.md`

## Локальная разработка (быстрый старт)

1) Установить зависимости:

```bash
pnpm install
```

2) Выбрать приложение и подготовить env:
- см. `.env.example` внутри нужного `apps/*` (например `apps/corporate-website/.env.example`).

3) Запустить dev‑сервер (пример для corporate):

```bash
pnpm --filter @synestra/corporate-website dev
```

## GitOps / Argo CD (обзор)

В `web-core` находятся:
- базовый шаблон деплоя (Helm chart): `deploy/charts/web-app`;
- значения per‑env/per‑deployment: `deploy/env/**`;
- ArgoCD Applications (per‑env): `deploy/argocd/apps/**`.

Реальные секреты (DB bootstrap/app user, Payload secret, интеграции и т.п.) создаются в GitLab репозитории `synestra-platform`.

## Официальные шаблоны Payload (референсы)

Снапшоты официальных шаблонов Payload храним в `upstream/` как **референс** для анализа и переноса паттернов (не для прямого деплоя):
- provenance: `upstream/payload/README.md`
- шаблоны: `upstream/payload/templates/*`
- результаты анализа: `docs/research/templates/*`
