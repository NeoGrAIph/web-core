# One-off Job: refresh `synestra-io` dev DB from prod DB (CNPG) inside the cluster.
#
# IMPORTANT:
# - This file is intentionally not wired into ArgoCD/Helm by default.
# - Apply it manually (or via Okteto deploy/pipeline) when you need a refresh.
#
# Preconditions:
# - Dev app is scaled down / no active DB connections (avoid locks).
# - You understand this is a dev-only operation.
#
# Source of truth: based on `synestra-platform/infra/databases/cloudnativepg/synestra-io-dev/refresh-dev-from-prod-job.yaml`.
apiVersion: batch/v1
kind: Job
metadata:
  name: refresh-synestra-io-dev-db-from-prod
  namespace: databases
  labels:
    app.kubernetes.io/name: refresh-synestra-io-dev-db-from-prod
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 60
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: refresh
          image: ghcr.io/cloudnative-pg/postgresql:17.7
          imagePullPolicy: IfNotPresent
          env:
            - name: PROD_PGUSER
              valueFrom:
                secretKeyRef:
                  name: synestra-io-initdb-secret
                  key: username
            - name: PROD_PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: synestra-io-initdb-secret
                  key: password
            - name: DEV_PGUSER
              valueFrom:
                secretKeyRef:
                  name: synestra-io-initdb-secret
                  key: username
            - name: DEV_PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: synestra-io-initdb-secret
                  key: password
            - name: DB_NAME
              value: synestra_io
            - name: PROD_HOST
              value: synestra-io-cnpg-rw.databases.svc.cluster.local
            - name: DEV_HOST
              value: synestra-io-dev-cnpg-rw.databases.svc.cluster.local
          command:
            - bash
            - -lc
            - |
              set -euo pipefail

              if [[ "${PROD_HOST}" == "${DEV_HOST}" ]]; then
                echo "ERROR: PROD_HOST == DEV_HOST (${PROD_HOST}). Refusing."
                exit 1
              fi

              if [[ "${DEV_HOST}" != *"-dev-"* ]]; then
                echo "ERROR: DEV_HOST (${DEV_HOST}) does not look like a dev cluster. Refusing."
                exit 1
              fi

              echo "Refreshing dev DB from prod..."
              echo "  PROD_HOST=${PROD_HOST}"
              echo "  DEV_HOST=${DEV_HOST}"
              echo "  DB_NAME=${DB_NAME}"

              # Notes:
              # - This runs entirely inside the cluster (no local dump files).
              # - Assumes dev workload is scaled down / no active connections to avoid lock conflicts.
              PGPASSWORD="${PROD_PGPASSWORD}" pg_dump -h "${PROD_HOST}" -U "${PROD_PGUSER}" -d "${DB_NAME}" -Fc \
                | PGPASSWORD="${DEV_PGPASSWORD}" pg_restore -h "${DEV_HOST}" -U "${DEV_PGUSER}" -d "${DB_NAME}" \
                  --clean --if-exists --no-owner --no-privileges

              echo "Done."
