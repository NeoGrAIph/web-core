name: web-core-payload-dev-refresh-db-media

# Okteto Deploy-only manifest.
# Purpose: run dev-only maintenance tasks from Okteto UI (Catalog) without `okteto up`.
#
# This is intended to be deployed into namespace `web-payload-dev`, but operates across namespaces:
# - `databases` (CNPG refresh job)
# - `web-payload-dev` (media mirror job)
#
# Docs:
# - https://www.okteto.com/docs/1.39/self-hosted/manage/custom-resource-definitions/
# - https://www.okteto.com/docs/development/deploy/deploy-from-catalog/
deploy:
  # Refresh DB (dev from prod)
  - kubectl -n databases delete job refresh-payload-dev-db-from-prod --ignore-not-found
  - kubectl apply -f deploy/jobs/db-refresh-payload-dev-from-prod.yaml
  - kubectl -n databases wait --for=condition=complete job/refresh-payload-dev-db-from-prod --timeout=60m
  - kubectl -n databases logs job/refresh-payload-dev-db-from-prod

  # Refresh Media (prod bucket -> dev bucket)
  - kubectl -n web-payload-dev delete job media-mirror-payload-dev-from-prod --ignore-not-found
  - kubectl -n web-payload-dev apply -f deploy/jobs/media-mirror-payload-dev-from-prod.yaml
  - kubectl -n web-payload-dev wait --for=condition=complete job/media-mirror-payload-dev-from-prod --timeout=60m
  - kubectl -n web-payload-dev logs job/media-mirror-payload-dev-from-prod
