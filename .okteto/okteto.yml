name: web-core

# Okteto manifest (v0, template-like).
# This repo uses ArgoCD for the baseline deploy; Okteto is used only for "dev mode on top".
#
# Usage example (after ArgoCD deploy of dev env):
#   okteto context use <our-okteto-instance>
#   okteto namespace web-synestra-io-dev
#   okteto up web-synestra-io-dev
#   # ... develop ...
#   okteto down web-synestra-io-dev
#
# Aliases (for compatibility with older docs/commands):
# - web-payload-dev-web-app -> web-payload-dev
# - web-synestra-io-dev-web-app -> web-synestra-io-dev
#
# Notes:
# - We run `next dev` on port 3000 so the existing Service/Ingress continues to work.
# - Because the manifest lives in `.okteto/okteto.yml`, Okteto expects `.okteto/.stignore` (otherwise it prompts interactively).

dev:
  web-payload-dev:
    # Target the ArgoCD-managed Deployment in namespace `web-payload-dev`.
    selector:
      app.kubernetes.io/name: web-app
      app.kubernetes.io/instance: web-payload-dev
    container: app
    workdir: /app
    command: sh -lc 'export CI=1 NODE_ENV=development COREPACK_ENABLE_DOWNLOAD_PROMPT=0 PNPM_STORE_DIR=/tmp/.pnpm-store; corepack enable >/dev/null 2>&1 || true; if [ ! -x node_modules/.bin/next ]; then pnpm install; fi; pnpm --filter @synestra/payload-core exec next dev --hostname 0.0.0.0 --port 3000'
    sync:
      - ..:/app
    forward:
      - 3000:3000

  web-payload-dev-web-app:
    # Alias for compatibility with older docs/commands.
    selector:
      app.kubernetes.io/name: web-app
      app.kubernetes.io/instance: web-payload-dev
    container: app
    workdir: /app
    command: sh -lc 'export CI=1 NODE_ENV=development COREPACK_ENABLE_DOWNLOAD_PROMPT=0 PNPM_STORE_DIR=/tmp/.pnpm-store; corepack enable >/dev/null 2>&1 || true; if [ ! -x node_modules/.bin/next ]; then pnpm install; fi; pnpm --filter @synestra/payload-core exec next dev --hostname 0.0.0.0 --port 3000'
    sync:
      - ..:/app
    forward:
      - 3000:3000

  web-synestra-io-dev:
    # Target the ArgoCD-managed Deployment in namespace `web-synestra-io-dev`.
    # Chart `deploy/charts/web-app` labels:
    # - app.kubernetes.io/name=web-app
    # - app.kubernetes.io/instance=<release>
    selector:
      app.kubernetes.io/name: web-app
      app.kubernetes.io/instance: web-synestra-io-dev
    container: app
    workdir: /app
    command: sh -lc 'export CI=1 NODE_ENV=development COREPACK_ENABLE_DOWNLOAD_PROMPT=0 PNPM_STORE_DIR=/tmp/.pnpm-store; corepack enable >/dev/null 2>&1 || true; if [ ! -x node_modules/.bin/next ]; then pnpm install; fi; pnpm --filter @synestra/synestra-io exec next dev --hostname 0.0.0.0 --port 3000'
    sync:
      - ..:/app
    forward:
      - 3000:3000

  web-synestra-io-dev-web-app:
    # Alias for compatibility with older docs/commands.
    selector:
      app.kubernetes.io/name: web-app
      app.kubernetes.io/instance: web-synestra-io-dev
    container: app
    workdir: /app
    command: sh -lc 'export CI=1 NODE_ENV=development COREPACK_ENABLE_DOWNLOAD_PROMPT=0 PNPM_STORE_DIR=/tmp/.pnpm-store; corepack enable >/dev/null 2>&1 || true; if [ ! -x node_modules/.bin/next ]; then pnpm install; fi; pnpm --filter @synestra/synestra-io exec next dev --hostname 0.0.0.0 --port 3000'
    sync:
      - ..:/app
    forward:
      - 3000:3000
